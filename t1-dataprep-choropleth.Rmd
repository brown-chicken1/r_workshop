---
title: "Preparation of Choropleth and other qualitative and quantitative thematic maps."
description: |
  A new article created using the Distill format.
output: distill::distill_article
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
```

## 1. Selection of Required Data

* Population Density by District
  + Population of Adults
  + Population of Seniors
* Economic and Businesses
  + Agriculture
  + Mining
  + Commerce
* Transport and communication
  + Airports
  + Bus Terminals
  + Seaports
  + Roads
* Infrastructures
  + Buildings
  + Electricity
  + Water supply
* Environment and Hazard
  + Forests
  + Forest fire

  
    ![](images/1DataPrep1.png){width=40%}
    + Select the newly imported layer and press "OK" in the resultant window.
    
    ![hi](images/1DataPrep2.png){width=40%}
  
    + Save the resultant layer in a GeoPackage format. Click on the newly created temporary layer, go to Export > Save Features As. In the resultant window, select the format **GeoPackage** and then create a new GeoPAckage file. Name the layer "FinalShape_Fixed geometries", leave all other features as intended, before saving.

## Clipping Layers into Study Area

The processing of each layer will differ according to their data type. We have sorted the layers that have been used into the following categories:

**Points**

+ TOPONIMI_PT_50k
+ TERMINALBUS_PT_50k 
+ Forest Fire

**Area**

+ Mining Areas
+ Non-Agricultural Forest Areas
+ Agricultural Areas
+ Settlements

**Mixed**

+ Airport (Both point and area)

**Lines**

+ Roads (gis_osm_roads)


### Processing Polyline (Road Layer)

* Import the layer (gis_osm_roads_a_free.shp).

* There is a need to join incomplete roads. Examine each road segment closely and find out which road segments can be joined, for example roads which go above the bridge. 

  + This will result in the intersection points being overstated when conducting site survey analysis. While it may not be possible to fix every road, most roads where this issue presents itself, are located along the coast or over bridges.
  
* We need to clip the road to the study area. Go to Vector > Geoprocessing Tools > Clip, make sure the newly imported road layer is input as the Input Layer, and the layer to be used as a clip is the FinalShape_Fixed geometries layer (Overlay Layer)that had been prepared.

![hi](images/1DataPrep4.png)

* Save the temporary layer as a GeoPackage layer with the correct CRS as **EPSG:23845 (DGN / Indonesia TM-3 zone 54.1)** and make sure under the "Geometry" tab, the data type is changed to "Line" and the "Include Z values" is not checked.

* Following that, toggle editing on the layer by clicking on the pencil icon. Make sure the selection method is "Select Features" and not other selection methods.

* Select the 2 road segments that are supposed to be joined together.

![hi](images/Picture12.png)

* Click on "Merge Selected Features" in order to merge the 2 line segments together to form a single feature, which we can then extend in order to touch the 2 edges of the line.

![hi](images/Picture13.png)

* Post-merge we have to re-select the merged segment which has become a single feature by clicking on the line segment. Following that we click on the "Reshape Feature".

![hi](images/Picture17.png)

* We click on the edge of one line and then drag it to the start of the other line, this will join the 2 line segments together to form a complete road.

![hi](images/Picture16.png) 

* Repeat this for all segments that have been found to have missing road segments.



  ![hi](images/1DataPrep12.png)
  
  + Remove all the previous temporary layers created by right clicking on them and selecting "Delete Selected Layer".
  
  + Save the newly created road layer by right clicking on it in the menu and selecting Save Features As, and in the resultant box that comes up, ensure that the GeoPackage file that the base map layer was selected, is selected under the file name and the layer name is set to "Roads", and the map CRS is set to EPSG:23845.

### Processing Area (Polygon) Data

* The area data needs to be merged into a single layer for analysis.
  + We first open up the characteristic of concern, for example, agricultural shrub layer. 
  
![hi](images/AreaPrep-1.png)

  + Following that, we need to clip the layers so that they only overlap our area of study. Go to Vector > Geoprocessing Tools > Clip, make sure the newly imported road layer is input as the Input Layer, and the layer to be used as a clip is the FinalShape_Fixed geometries layer (Overlay Layer)that had been prepared.
    + *NB: If the geometries are invalid it is required to use the "Fix Geometries" tool from the Processing > Toolbox (CTRL+ALT+T) befire moving forward with the analysis.

![Image was used to process road section data but the methodology is the same](images/1DataPrep4.png) 

* The completed, clipper layers should look like this: 


![hi](images/AreaPrep-2.png)

* The different areas then need to be combined together. Go to the Processing toolbox on the bottom right hand corner of the page and select "Merge vector layers". 

* In the resulting window, select the desired layers to be merged, for example:
  
![hi](images/AreaPrep-3.png)
* We keep the CRS as it is; we will change the CRS when we export as a GeoPackage.
  
* After merging, the layers should appear as this:
  
![hi](images/AreaPrep-4.png)

* The layers can now be saved as a GeoPackage. Click on the newly merged layer, go to Export > SavE Features As > and name the layer a good name (for example, MergedShrubs). Make sure GeoPAckage is selected as the format, and the chosen GeoPackage is the one in which the base layers are saved in.
  
* Change the "Geometry Type" to 'Polygon" and uncheck the "Include Z-dimension". 

![hi](images/AreaPrep-5.png)

* Repeat this step for all other applicable layers that are in the "Polygon" format.

### Processing Point Data

* The point data needs to be merged into a single layer for analysis.
  
* We first open up the characteristic of concern, for example, toponimi layer (TOPONIMI_PT_50k).
  
* In some layers, we are only interested in certain attributes. For example, for the Toponimi Layer, we are interested in the "Kantor Banks". Therefore, some filters need to be applied.
    
  + We right click on the layer > Open Attribute Table. 
    
  + We toggle the editing by clicking the pencil icon near the top of the window. 
    
  + Following that, we sort the table by "Remark" by clicking on it, and then selecting all the rows with attribute Remark = "Kantor Bank". 
  
    ![hi](images/Picture11.png){fig.width = 50px}
    
* We then close the attribute table, and toggle editing on the Toponimi layer (or any other point layer of concern). Following that, we copy the selection, and paste it in a new scratch layer by going to Edit > Paste > Temporary Scratch Layer. It would be good practice to rename the temporary scratch layer for later (for e.g, KK Kantor Bank, PPU Kantor Bank etc)
    
* We repeat all steps up till this one, for the same data of interest, for other regencies / cities.
    
* Repeat the steps above for the line data, in order to merge the layers:

* First, we select the layers that describe our attribute in question. Go to the Processing Toolbox and search for "Merge Vector Layers", and select the layers which we have just added. For example, if we were working on the toponimi layer we would add in the temporary layers created previously e.g KK Kantor Bank, PPU Kantor Bank, KS Kantor Bank. We leave the CRS as is, and then run the algorithm.
  
![hi](images/AreaPrep-6.png)  

* Before saving the layer we need to take care of duplicate points since they might be represented multiple times. Go to the Processing Toolbox and search for "Delete Duplicate Geometries" When the window opens, we use the layer that we had just created in the previous step as the Input layer, and then run.
  
![hi](images/AreaPrep-7.png)

* After running, the duplicate geometries (For example, one bank at the same location might be represented by multiple points in different layers) should be removed. We can then save this layer in our GeoPackage file. Right click on the processed layer, select "Save Features As", and make sure GeoPackage is selected in the window that comes up. Navigate to the GeoPackage that contains the base layer, and name our layer "AllBanks_Vector", or for whatever attribute of interest that is being explored. Make sure the CRS is set to EPSG:23845 and the "Point" datatype is set in Geometry, as well as the "Include Z dimension" is unchecked, then save the newly formed layer.

![hi](images/AreaPrep-8.png)



### Processing Point and Polygonal Data

This section should only be applicable to the airport layer, because the point data for airports comprise an additional airport that is not presented in the area data. It is important, because this missing airport is the new international airport for Samarinda and can absolutely not be eliminated from the study.

* The general approach is to create a new polygon where the data is needed.

* Import the airport polygon and point layers. And view them. We see that there's a point that doesn't have a corresponding polygon, and a polygon inside Samarinda that is the decomissioned airport which has to be deleted.

![hi](images/Airport4.png)

* For the point layer that we need to add a polygon to, we first toggle the editing by clicking on the pencil icon on the top bar.

![hi](images/Airport3.png)

* Following that we click on the "Add Polygon" next to it and draw it around the OSM layer boundary of the airport. To complete the shape we right click; to add a corner of the polygon we left click.

![hi](images/Airport5.png)

* Once the shape is created an additional window will come out to enter the attributes. To know the attributes to add, we have to open the point layer attributes, so we toggle the Information tool and click on the point layer. A window will pop up with the attributes. We transfer the data in the NAMOBJ and REMARK column to the attributes of our newly created polygon. Then we click "OK".

![hi](images/Airport5.png)

![hi](images/Airport7.png)

* To remove the decommissioned airport, we click on the Select tool, move down to its location, select the airport and press the Delete key on the keyboard. 

![hi](images/Airport8.png)

* After these 2 modifications are complete we then toggle editing off by clicking on the pncil button again then accepting the changes that are made.

* Following that, we follow the rest of the procedures in the Area Dataset processing in order to merge the vector layers together and then export them.






    

